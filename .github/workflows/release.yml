name: Release

on:
  push:
    branches: [main]
    paths:
      - 'Sources/**'
      - 'Resources/**'
      - 'Package.swift'
      - 'Package.resolved'

permissions:
  contents: write
  models: read

jobs:
  build-and-release:
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: Calculate version
        id: calc-version
        shell: bash
        run: |
          git fetch --tags || true
          # Find latest semver tag, default to v0.0.0
          LATEST=$(git tag -l 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | head -n1)
          LATEST=${LATEST:-v0.0.0}
          # Bump patch version
          MAJOR=$(echo "$LATEST" | sed 's/^v//' | cut -d. -f1)
          MINOR=$(echo "$LATEST" | sed 's/^v//' | cut -d. -f2)
          PATCH=$(echo "$LATEST" | sed 's/^v//' | cut -d. -f3)
          TAG="v${MAJOR}.${MINOR}.$((PATCH + 1))"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "prev=$LATEST" >> $GITHUB_OUTPUT
          if git show-ref --tags --verify --quiet "refs/tags/$TAG"; then
            echo "skip=yes" >> $GITHUB_OUTPUT
          else
            echo "skip=no" >> $GITHUB_OUTPUT
          fi

      - name: Build
        if: steps.calc-version.outputs.skip == 'no'
        run: swift build -c release

      - name: Package
        if: steps.calc-version.outputs.skip == 'no'
        env:
          VER: ${{ steps.calc-version.outputs.tag }}
        run: |
          ./scripts/install.sh --no-install --version "$VER"

      - name: Notes
        if: steps.calc-version.outputs.skip == 'no'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PREV="${{ steps.calc-version.outputs.prev }}"
          
          echo "## HueBar" > notes.txt
          echo "" >> notes.txt
          echo "Native macOS menubar app for controlling Philips Hue lights" >> notes.txt
          echo "" >> notes.txt
          
          if [ -n "$PREV" ]; then
            COMMITS=$(git log --pretty=format:"- %s" ${PREV}..HEAD)
            
            PROMPT="Summarize these git commits into concise, user-friendly release notes. Group related changes. Use markdown bullet points. Focus on what changed from a user's perspective, not implementation details. Keep it short â€” max 10 bullet points. Do not include a header, just the bullets.

Commits:
${COMMITS}"
            
            SUMMARY=$(echo "$PROMPT" | gh models run gpt-4o-mini 2>/dev/null) || SUMMARY=""
            
            if [ -n "$SUMMARY" ]; then
              echo "### What's Changed" >> notes.txt
              echo "" >> notes.txt
              echo "$SUMMARY" >> notes.txt
            else
              echo "### What's Changed" >> notes.txt
              echo "" >> notes.txt
              echo "$COMMITS" >> notes.txt
            fi
          else
            cat .github/release-notes-initial.md >> notes.txt
          fi
          
          echo "" >> notes.txt
          cat .github/release-notes-footer.md >> notes.txt

      - name: Release
        if: steps.calc-version.outputs.skip == 'no'
        uses: softprops/action-gh-release@c062e08bd532815e2082a85e87e3ef29c3e6d191
        with:
          tag_name: ${{ steps.calc-version.outputs.tag }}
          name: ${{ steps.calc-version.outputs.tag }}
          body_path: notes.txt
          files: HueBar.zip
