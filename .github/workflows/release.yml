name: Release

on:
  push:
    branches: [main]
    paths:
      - 'Sources/**'
      - 'Resources/**'
      - 'Package.swift'
      - 'Package.resolved'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: Calculate version
        id: calc-version
        shell: bash
        run: |
          SHORT=$(git rev-parse --short HEAD)
          TSTAMP=$(date -u +%Y.%m.%d)
          TAG="v${TSTAMP}-${SHORT}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          git fetch --tags || true
          if git show-ref --tags --verify --quiet "refs/tags/$TAG"; then
            echo "skip=yes" >> $GITHUB_OUTPUT
          else
            echo "skip=no" >> $GITHUB_OUTPUT
          fi

      - name: Build
        if: steps.calc-version.outputs.skip == 'no'
        run: swift build -c release

      - name: Package
        if: steps.calc-version.outputs.skip == 'no'
        env:
          VER: ${{ steps.calc-version.outputs.tag }}
        run: |
          ./scripts/install.sh --no-install --version "$VER"

      - name: Notes
        if: steps.calc-version.outputs.skip == 'no'
        run: |
          PREV=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          # Always start with header
          echo "## HueBar" > notes.txt
          echo "" >> notes.txt
          echo "Native macOS menubar app for controlling Philips Hue lights" >> notes.txt
          echo "" >> notes.txt
          
          # Generate changelog
          if [ -n "$PREV" ]; then
            echo "### What's Changed" >> notes.txt
            echo "" >> notes.txt
            git log --pretty=format:"- %s" ${PREV}..HEAD >> notes.txt
            echo "" >> notes.txt
          else
            echo "### Features" >> notes.txt
            echo "" >> notes.txt
            echo "- ðŸ’¡ Room and zone control with on/off toggles" >> notes.txt
            echo "- ðŸŽšï¸ Brightness and color adjustment" >> notes.txt
            echo "- ðŸŽ¨ Scene activation and browsing" >> notes.txt
            echo "- ðŸ’¡ Individual light control" >> notes.txt
            echo "- âŒ¨ï¸ Global keyboard shortcuts" >> notes.txt
            echo "- ðŸ˜´ Sleep/wake automation" >> notes.txt
            echo "- ðŸ”„ Real-time updates via SSE" >> notes.txt
            echo "" >> notes.txt
          fi
          
          echo "## Installation" >> notes.txt
          echo "" >> notes.txt
          echo "1. Download **HueBar.zip** below" >> notes.txt
          echo "2. Unzip and move **HueBar.app** to `/Applications`" >> notes.txt
          echo "3. Launch HueBar and connect to your Hue Bridge" >> notes.txt
          echo "" >> notes.txt
          echo "**Requirements:** macOS 15.0 (Sequoia) or later" >> notes.txt

      - name: Release
        if: steps.calc-version.outputs.skip == 'no'
        uses: softprops/action-gh-release@c062e08bd532815e2082a85e87e3ef29c3e6d191
        with:
          tag_name: ${{ steps.calc-version.outputs.tag }}
          name: ${{ steps.calc-version.outputs.tag }}
          body_path: notes.txt
          files: HueBar.zip
